<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/Layouts}">
<head>
    <title>User Order History</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2/dist/stomp.min.js"></script>
	<link th:fragment="css" th:href="@{/css/index.css}" rel="stylesheet"/>
	<link th:fragment="css" th:href="@{/css/custom.css}" rel="stylesheet"/>
	<link th:fragment="css" th:href="@{/css/orderHistory.css}" rel="stylesheet" />
</head>
<body>
<h1>유저 주문 내역</h1>

 <section layout:fragment="content">
  <h1>유저 주문 내역</h1>

  <div class="order-history">
    <p th:if="${history == null or #lists.isEmpty(history)}" class="no-orders">
      아직 주문 내역이 없습니다.
    </p>

    <div th:each="order : ${history}" class="order-box">
      <div class="order-box-content">
        <!-- 왼쪽: 매장 대표 이미지 -->
        <div class="store-image">
          <img th:src="${order.storeImageUrl}" alt="매장 이미지" />
        </div>
        <!-- 오른쪽: 상세 정보 -->
        <div class="order-details">
          <span class="status" th:text="${order.orderStatus}">배달중</span>
          <h3 class="store-name" th:text="${order.storeName}">가게 이름</h3>
          <!-- 메뉴 항목 2개까지만, 나머지는 "외 n개" -->
          <p class="menu-summary">
            <span th:each="item,iterStat : ${order.menuItems}"
                  th:if="${iterStat.index < 2}"
                  th:text="${iterStat.index == 0 ? item : ', ' + item}">
              메뉴1, 메뉴2
            </span>
            <span th:if="${order.menuItems.size() > 2}"
                  th:text="'외 ' + (${order.menuItems.size()} - 2) + '개'">
              외 n개
            </span>
          </p>
        </div>
      </div>

      <!-- 하단: 상세 정보 보기 버튼 -->
      <div class="order-box-footer">
        <a th:href="@{'/user/order/' + ${order.orderId}}"
           class="btn btn-outline-primary">
          상세 정보 보기
        </a>
        <a th:href="@{'/writeReview/' + ${order.orderId}}" class="btn btn-outline-secondary">
        	리뷰 작성
        </a>
      </div>
    </div>
  </div>
</section>


<script>
let stompClient = null;
const userId = "user123"; // 실제 로그인 유저ID, 혹은 UUID

function connect() {
    const socket = new SockJS('/stomp');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, function(frame) {
        console.log("Connected: " + frame);
        // /topic/user/{userId} 채널 구독
        stompClient.subscribe('/topic/user/' + userId, function(message) {
            const updatedOrder = JSON.parse(message.body);
            handleOrderUpdate(updatedOrder);
        });
    });
}

function handleOrderUpdate(order) {
    // 받은 주문 데이터(orderStatus 등)를 확인하여
    // 페이지 내 주문 목록/상세 UI를 업데이트
    alert("주문 상태 변경됨: " + order.orderStatus);

    // 예를 들어, 특정 주문 DOM을 찾아 상태 표시
    // or 전체 리스트 다시 로드
}

window.onload = connect;
</script>

</body>
</html>