<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/Layouts}">

<head>
    <link th:fragment="css" th:href="@{/css/deliveryMap.css}"
        rel="stylesheet" />
    <link th:fragment="css" th:href="@{/css/RiderCustom.css}" rel="stylesheet" />
    <link th:fragment="css" th:href="@{/css/index.css}" rel="stylesheet" />
    <link th:fragment="css" th:href="@{/css/RiderIndex.css}" rel="stylesheet" />
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.4/dist/css/bootstrap.min.css"
        rel="stylesheet">
    <script th:src="@{/js/hideLogo.js}"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>

    <!-- JavaScript Fragment -->
        <!-- Kakao Maps API -->
             <!-- âœ… 1. Kakao SDK ë¨¼ì € ë¶ˆëŸ¬ì˜¤ê¸° (defer ì ˆëŒ€ ê¸ˆì§€) -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=3ed46db13320cf31ee95b563f78b8740&autoload=false&libraries=services"></script>

    <!-- âœ… 2. ì¢Œí‘œ ë° riderId Thymeleafë¡œ ì „ë‹¬ -->
    <script>
        const lat = parseFloat('[[${rider.hubAddressLatitude}]]');
        const lng = parseFloat('[[${rider.hubAddressLongitude}]]');
        const riderId = '[[${rider.riderId}]]';
        let map, intervalId = null, stompClient = null;
    </script>

    <!-- âœ… 3. WebSocket + Kakao Map + Marker í†µí•© -->
    <script>
        window.onload = function () {
        	console.log("ğŸ”¥ window.onload ì‹¤í–‰ë¨");

            // Kakao ì§€ë„ ë¡œë“œ
            if (typeof kakao !== 'undefined') {
		        kakao.maps.load(function () {
		            const mapContainer = document.getElementById('map');
		            const mapOption = {
		                center: new kakao.maps.LatLng(lat, lng),
		                level: 3
		            };
	            map = new kakao.maps.Map(mapContainer, mapOption);
	
	            startGenerating();
	            document.getElementById('stopBtn').addEventListener('click', stopGenerating);
	            document.getElementById('startBtn').addEventListener('click', startGenerating);
		        });
		    } else {
		        console.warn("âš ï¸ Kakao SDK ë¡œë“œ ì‹¤íŒ¨ â†’ ì§€ë„ë§Œ ë¹„í™œì„±í™”ë¨");
		    }

            // WebSocket ì—°ê²°
            console.log("ğŸ”¥ connect() í•¨ìˆ˜ ì§„ì…");
            const socket = new SockJS('/stomp');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                console.log("âœ… WebSocket ì—°ê²° ì„±ê³µ");
                stompClient.subscribe('/topic/rider/' + riderId, function (message) {
                    const updatedOrder = JSON.parse(message.body);
                    console.log("ğŸ“¦ ë©”ì‹œì§€ ìˆ˜ì‹ :", updatedOrder);
                    alert("ë°°ë‹¬ ì£¼ë¬¸ ìƒíƒœ ë³€ê²½: " + updatedOrder.orderStatus);
                });
            }, function (error) {
                console.error("âŒ WebSocket ì—°ê²° ì‹¤íŒ¨:", error);
            });
            
            connect(); // âœ… ì—¬ê¸°ê°€ ì‹¤ì œ ì—°ê²° ì‹œì‘
        };

        function startGenerating() {
            if (intervalId === null) {
                intervalId = setInterval(() => addRandomMarker(lat, lng), 5000);
            }
        }

        function stopGenerating() {
            if (intervalId !== null) {
                clearInterval(intervalId);
                intervalId = null;
            }
        }

        function addRandomMarker(baseLat, baseLng) {
            let randomLat = baseLat + (Math.random() - 0.5) * 0.01;
            let randomLng = baseLng + (Math.random() - 0.5) * 0.01;

            let imageSrc = 'https://ifh.cc/g/HMrtaC.png',
                imageSize = new kakao.maps.Size(30, 30),
                imageOption = { offset: new kakao.maps.Point(27, 69) };

            let markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption),
                markerPosition = new kakao.maps.LatLng(randomLat, randomLng);

            let marker = new kakao.maps.Marker({
                position: markerPosition,
                image: markerImage
            });
            marker.setMap(map);

            const storeName = "ëœë¤ì‹ë‹¹";
            const price = Math.floor(Math.random() * 5000) + 1000;
            const orderId = 'order-' + crypto.randomUUID();

            let content = `
                <div class="delivery-request" id="${orderId}" style="cursor:pointer;">
                    <strong>${storeName}</strong><br>${price}ì›
                </div>
            `;

            let customOverlay = new kakao.maps.CustomOverlay({
                map: map,
                content: content,
                position: markerPosition,
                yAnchor: 1
            });

            // ì˜¤ë²„ë ˆì´ê°€ ë¶™ê³  ë‚˜ì„œ í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
            setTimeout(() => {
                const element = document.getElementById(orderId);
                if (element) {
                    element.addEventListener('click', function () {
                        displayOrderInfo(storeName, price);
                    });
                }
            }, 50);
        }
        </script> 
</head>

<div layout:fragment="content">
    <!-- ì§€ë„ ì˜ì—­ -->
      <div id="map" style="width: 100%; height: 400px;"></div> 
    <div style="margin: 10px;">
        <button id="stopBtn">ì£¼ë¬¸ ê·¸ë§Œ ìƒì„±í•˜ê¸°</button>
        <button id="startBtn">ë‹¤ì‹œ ì‹œì‘</button>
    </div>
    <div id="order-info">
    <h4>ì£¼ë¬¸ ì •ë³´</h4>

    <div class="info-header">
        <div id="storeName"><span>ì—…ì¥ëª…</span><br><small id="orderDate">ì£¼ë¬¸ì¼ì</small></div>
        <div id="orderId">ë°°ë‹¬ ë²ˆí˜¸</div>
    </div>

     <div class="info-grid">
        <div class="info-box" id="deliveryFee">
            <span>ë°°ë‹¬ë£Œ</span>
            <span class="value" id="deliveryFee"></span>
        </div>
        <div class="info-box">
            <span class="label">ì¡°ë¦¬ ì™„ë£Œ ì˜ˆìƒ ì‹œê°„</span><br>
            <span class="value" id="cookingTime"></span>
        </div>
    </div>

    <div class="textarea-box">
        <span class="label">ì£¼ë¬¸ ìš”ì²­ ì‚¬í•­</span><br>
        <span class="value" id="storeRequest"></span>
    </div>
    <div class="textarea-box">
        <span class="label">ë°°ë‹¬ ìš”ì²­ ì‚¬í•­</span><br>
        <span class="value" id="deliveryRequest"></span>
    </div>

    <div class="info-grid">
        <div class="info-box">
            <span class="label">ì¶œë°œì§€</span><br>
            <span class="value" id="startAddress"></span>
        </div>
        <div class="info-box">
            <span class="label">ë„ì°©ì§€</span><br>
            <span class="value" id="endAddress"></span>
        </div>
    </div>
	<div class="info-grid">
        <div class="info-box">
            <span class="label">ìš´í–‰ ê±°ë¦¬</span><br>
            <span class="value" id="distance"></span>
        </div>
        <div class="info-box">
            <span class="label">ê²°ì œ ì¢…ë¥˜</span><br>
            <span class="value" id="paymentType"></span>
        </div>
    </div>

     <div class="action-buttons">
        <button id="assignBtn">ë°°ì°¨</button>
        <button class="cancel">ì·¨ì†Œ</button>
    </div>
</div>
</div>
</html>
