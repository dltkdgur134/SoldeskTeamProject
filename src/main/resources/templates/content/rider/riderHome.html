<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/Layouts}">

<head>
    <script
        src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.4/dist/css/bootstrap.min.css"
        rel="stylesheet">
    <link th:fragment="css" th:href="@{/css/deliveryMap.css}"
        rel="stylesheet" />
    <link th:fragment="css" th:href="@{/css/RiderCustom.css}" rel="stylesheet" />
    <link th:fragment="css" th:href="@{/css/index.css}" rel="stylesheet" />
    <link th:fragment="css" th:href="@{/css/RiderIndex.css}" rel="stylesheet" />
    <link th:fragment="css" th:href="@{/css/infopage.css}" rel="stylesheet" />
    <script th:src="@{/js/hideLogo.js}"></script>

    <!-- JavaScript Fragment -->
        <!-- Kakao Maps API -->
         <script
            src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=3ed46db13320cf31ee95b563f78b8740"></script>

        <!-- Thymeleaf에서 위도 경도 값을 넘겨받기 -->
        
         <script>
            /*<![CDATA[*/
            var lat = parseFloat('[[${rider.hubAddressLatitude}]]');
            var lng = parseFloat('[[${rider.hubAddressLongitude}]]');
            console.log("Latitude: ", lat);
            console.log("Longitude: ", lng);
            /*]]>*/
        </script>
         <script>
            // map 변수를 처음에 한 번만 선언
            let map;
            let intervalId = null;

            document.addEventListener("DOMContentLoaded", function () {
                const mapContainer = document.getElementById('map');
                const mapOption = {
                    center: new kakao.maps.LatLng(lat, lng),
                    level: 3
                };
                // map 변수에 지도 객체 할당
                map = new kakao.maps.Map(mapContainer, mapOption);

                startGenerating(); // 시작 시 자동 생성

                document.getElementById('stopBtn').addEventListener('click', stopGenerating);
                document.getElementById('startBtn').addEventListener('click', startGenerating);
            });

            function startGenerating() {
                if (intervalId === null) {
                    intervalId = setInterval(() => {
                        addRandomMarker(lat, lng);
                    }, 5000);
                }
            }

            function stopGenerating() {
                if (intervalId !== null) {
                    clearInterval(intervalId);
                    intervalId = null;
                }
            }

            function displayOrderInfo(storeName, price) {
                const orderNameElement = document.getElementById("storeName").getElementsByTagName("span")[0];
                const orderPriceElement = document.getElementById("deliveryFee").getElementsByTagName("span")[0];

                orderNameElement.textContent = storeName;  // 식당 이름 표시
                orderPriceElement.textContent = price + "원";  // 가격 표시
            }
            
            function addRandomMarker(baseLat, baseLng) {
                let randomLat = baseLat + (Math.random() - 0.5) * 0.01;
                let randomLng = baseLng + (Math.random() - 0.5) * 0.01;

                let imageSrc = 'https://ifh.cc/g/HMrtaC.png',
                    imageSize = new kakao.maps.Size(30, 30),
                    imageOption = { offset: new kakao.maps.Point(27, 69) };

                let markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption),
                    markerPosition = new kakao.maps.LatLng(randomLat, randomLng);

                let marker = new kakao.maps.Marker({
                    position: markerPosition,
                    image: markerImage
                });
                marker.setMap(map);

                const storeName = "랜덤식당";
                const price = Math.floor(Math.random() * 5000) + 1000;

                // 유니크한 order ID 생성
                const orderId = 'order-' + crypto.randomUUID();

                let content = `
                    <div class="delivery-request" id="${orderId}" 
                    style="cursor:pointer;">
                        <strong>${storeName}</strong><br>${price}원
                    </div>
                `;

                let customOverlay = new kakao.maps.CustomOverlay({
                    map: map,
                    content: content,
                    position: markerPosition,
                    yAnchor: 1
                });

                // 오버레이가 DOM에 붙은 직후, 해당 ID로 요소 가져와 이벤트 바인딩
                setTimeout(() => {
                    const element = document.getElementById(orderId);
                    if (element) {
                        element.addEventListener('click', function () {
                            displayOrderInfo(storeName, price);
                        });
                    }
                }, 50); // DOM이 붙는 걸 기다림
            }
        </script> 
</head>

<div layout:fragment="content">
    <!-- 지도 영역 -->
      <div id="map" style="width: 100%; height: 400px;"></div> 
    <div style="margin: 10px;">
        <button id="stopBtn">주문 그만 생성하기</button>
        <button id="startBtn">다시 시작</button>
    </div>
    <div id="order-info">
    <h4>주문 정보</h4>

    <div class="info-header">
        <div id="storeName"><span>업장명</span><br><small id="orderDate">주문일자</small></div>
        <div id="orderId">배달 번호</div>
    </div>

     <div class="info-grid">
        <div class="info-box" id="deliveryFee">
            <span>배달료</span>
            <span class="value" id="deliveryFee"></span>
        </div>
        <div class="info-box">
            <span class="label">조리 완료 예상 시간</span><br>
            <span class="value" id="cookingTime"></span>
        </div>
    </div>

    <div class="textarea-box">
        <span class="label">주문 요청 사항</span><br>
        <span class="value" id="storeRequest"></span>
    </div>
    <div class="textarea-box">
        <span class="label">배달 요청 사항</span><br>
        <span class="value" id="deliveryRequest"></span>
    </div>

    <div class="info-grid">
        <div class="info-box">
            <span class="label">출발지</span><br>
            <span class="value" id="startAddress"></span>
        </div>
        <div class="info-box">
            <span class="label">도착지</span><br>
            <span class="value" id="endAddress"></span>
        </div>
    </div>
	<div class="info-grid">
        <div class="info-box">
            <span class="label">운행 거리</span><br>
            <span class="value" id="distance"></span>
        </div>
        <div class="info-box">
            <span class="label">결제 종류</span><br>
            <span class="value" id="paymentType"></span>
        </div>
    </div>

     <div class="action-buttons">
        <button id="assignBtn">배차</button>
        <button class="cancel">취소</button>
    </div>
</div>
</div>

</html>
