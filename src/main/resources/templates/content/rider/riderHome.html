<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/Layouts}">

<head>
	<link th:fragment="css" th:href="@{/css/deliveryMap.css}" rel="stylesheet" />
	<link th:fragment="css" th:href="@{/css/RiderCustom.css}" rel="stylesheet" />
	<link th:fragment="css" th:href="@{/css/index.css}" rel="stylesheet" />
	<link th:fragment="css" th:href="@{/css/RiderIndex.css}" rel="stylesheet" />
	<link th:fragment="css" th:href="@{/css/riderStatus.css}" rel="stylesheet" />
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.4/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
</head>

<body>
	<div layout:fragment="content">
		<!-- ì§€ë„ ì˜ì—­ -->
		<div id="map" style="width: 100%; height: 400px;"></div>
		<div class="rider-status">
			<div id="status-indicator" class="status-indicator waiting">
				<span class="dot"></span>
				<span class="label">ëŒ€ê¸°</span>
			</div>
			<p id="summary" class="mb-2 text-muted"></p>
			<button id="change-btn" class="btn btn-primary change-status">ë³€ ê²½</button>
		</div>
		<br>
		<!-- ì£¼ë¬¸ ëª©ë¡ ì¶œë ¥ -->
		<div id="order-list">
			<h4>ì£¼ë¬¸ ëª©ë¡</h4>
			<div id="order-items">
				<!-- ì—¬ê¸° ì•ˆì— ê° ì£¼ë¬¸ í•­ëª©ì´ ë™ì ìœ¼ë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤. -->
			</div>
		</div>

		<!-- Kakao Maps API -->
		<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=a82eb7e13124954eb1c020ac4cece497"></script>
		<script src="/js/riderMap.js"></script>

		<script th:inline="javascript">
			const riderLat = /*[[${rider.hubAddressLatitude}]]*/0;
			const riderLng = /*[[${rider.hubAddressLongitude}]]*/0;
		</script>

		<script th:inline="javascript">
			const orders = /*[[${ordersJson}]]*/[];
			console.log("ğŸ“¦ Orders loaded: ", orders);
		</script>
		<script th:inline="javascript">
			const riderId = /*[[${riderId}]]*/ "fallback-id"; // riderId ë™ì ìœ¼ë¡œ ì£¼ì…
		</script>

		<script>
		  async function loadRiderStatus() {
		    try {
		      const res = await fetch(`/rider/${riderId}`);
		      if (!res.ok) throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${res.statusText}`);
		      const rider = await res.json();
		      if (rider && rider.riderStatus) {
		        updateStatusIndicator(rider.riderStatus); 
		      } else {
		        throw new Error("ìœ íš¨í•œ ìƒíƒœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
		      }
		    } catch (e) {
		      console.error("ìƒíƒœ ë¡œë”© ì‹¤íŒ¨", e);
		      const label = document.querySelector("#status-indicator .label");
		      if (label) label.textContent = "ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨";
		    }
		  }

		  // âœ… ì—¬ê¸°ê°€ loadRiderStatus í•¨ìˆ˜ ë°”ê¹¥!
		  document.getElementById("change-btn").addEventListener("click", async () => {
		    try {
		      await fetch(`/rider/${riderId}/status`, { method: "PUT" });
		      await loadRiderStatus();
		    } catch (e) {
		      alert("ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨");
		      console.error(e);
		    }
		  });

		  function updateStatusIndicator(status) {
		    const indicator = document.getElementById("status-indicator");
		    const label = indicator.querySelector(".label");
		    indicator.className = "status-indicator"; // ì´ˆê¸°í™”
		    switch (status) {
		      case "WAITING":
		        indicator.classList.add("waiting");
		        label.textContent = "ëŒ€ê¸°";
		        break;
		      case "DELIVERING":
		        indicator.classList.add("delivering");
		        label.textContent = "ë°°ë‹¬ ì¤‘";
		        break;
		      case "RESTING":
		        indicator.classList.add("resting");
		        label.textContent = "íœ´ì‹ ì¤‘";
		        break;
		    }
		  }

		  // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
		  loadRiderStatus();
		</script>
	</div>
</body>
</html>