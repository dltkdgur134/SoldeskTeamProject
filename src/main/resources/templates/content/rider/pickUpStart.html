<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layouts/Layouts}">

<head>
<style>#map { width: 100vw; height: 100vh; }</style>
    <link th:fragment="css" th:href="@{/css/RiderCustom.css}" rel="stylesheet" />
    <link th:fragment="css" th:href="@{/css/index.css}" rel="stylesheet" />
    <link th:fragment="css" th:href="@{/css/RiderIndex.css}" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.4/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>

    <!-- 카카오 맵 API -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=a82eb7e13124954eb1c020ac4cece497"></script>
    
    <script>
    window.onload = function() {
        const routeData = JSON.parse(sessionStorage.getItem("routeData"));
        if (routeData) {
            console.log("Loaded Route Data:", routeData);

            

            // 카카오맵 API 초기화
            kakao.maps.load(function() {
                var container = document.getElementById('map');
                
                var options = {
                    center: new kakao.maps.LatLng(routeData.start.lat, routeData.start.lng), // 출발지 좌표
                    level: 4 // 지도 확대 수준
                };
                var map = new kakao.maps.Map(container, options);
                
                var markers = [];
                var polylines = [];
                
                // 마커 1개 (출발지)
                var startPosition = new kakao.maps.LatLng(routeData.start.lat,routeData.start.lng); // 출발지
                console.log(startPosition);
                var waypointPosition = new kakao.maps.LatLng(routeData.waypoint.lat,routeData.waypoint.lng); // 경유지
				console.log(waypointPosition);
                
                var startMarker = new kakao.maps.Marker({
                    position: startPosition,
                    map: map
                });

                var waypointMarker = new kakao.maps.Marker({
                    position: waypointPosition,
                    map: map
                });
             // 경로 데이터에서 path1를 가져옵니다.
                var path1 = routeData.path1; // path1 배열
                console.log(path1);  // path1 값 확인
                
                
                // 폴리라인 1개 (출발지 -> 경유지)
                var polyline = new kakao.maps.Polyline({
                    path: path1.map(coord => {
                        // 좌표 값이 유효한지 체크
                        if (typeof coord.lat === 'number' && typeof coord.lng === 'number') {
                            return new kakao.maps.LatLng(coord.lat, coord.lng);
                        } else {
                            console.error('Invalid coordinate:', coord);  // 잘못된 좌표 로그
                            return null;  // 잘못된 좌표는 무시
                        }
                    }).filter(coord => coord !== null),  // null 값을 제외하고 경로에 추가
                    strokeWeight: 5,
                    strokeColor: '#FF0000',
                    strokeOpacity: 1,
                    strokeStyle: 'solid'
                });

                polyline.setMap(map);
            });
        } else {
            console.error("routeData가 없습니다.");
        }
    };
    </script>
</head>

<body>
    <div layout:fragment="content" class="message-container">
        <div class="message">
            <div id="map" style="width:100%; height:400px;"></div>
        </div>

        <p>
            <form action="/rider/deliveryStart" method="post" style="display: inline;">
                <input type="hidden" name="orderId" th:value="${orderId}">
                <button type="submit" class="btn btn-success btn-lg" id="startDeliveryBtn">
                    배달 시작하기
                </button>
            </form>
        </p>
    </div>
</body>
</html>
