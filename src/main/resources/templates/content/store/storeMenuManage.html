<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>ë©”ë‰´ ê´€ë¦¬</title>
	<link rel="stylesheet" th:href="@{/css/storeMenuManage.css}">
</head>
<body th:attr="data-store-id=${store.storeId}" data-store-id="">
	<header class="menu-header">
		<h2 th:text="${store.storeName} + ' ë©”ë‰´ ê´€ë¦¬'">ê°€ê²Œ ì´ë¦„ ë©”ë‰´ ê´€ë¦¬</h2>
	</header>
	
	<section class="menu-tabs" id="category-buttons">
		
	</section>
	
	<section class="menu-list" id="menu-list-container">
		<div class="menu-card" th:each="menu : ${menuList}" th:attr="data-menu-id=${menu.menuId}, data-category=${menu.menuCategory}" style="cursor:pointer;">
			<img th:src="${menu.menuImg}" alt="menu image" />
			<div class="info">
				<h3 th:text="${menu.menuName}">ë©”ë‰´ëª…</h3>
				<p th:text="${menu.price} + 'ì›'">ê°€ê²©</p>
			</div>
		</div>
	</section>

	<section class="add-btn-wrap">
		<button class="add-btn" onclick="openMenuModal()">+ ìƒˆ ë©”ë‰´ ì¶”ê°€</button>
	</section>
	
	<div id="categoryModal" class="modal-overlay" style="display:none;">
		<div class="modal-content">
			<span class="close-btn" onclick="closeCategoryModal()">&times;</span>
			<h2>ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</h2>
			<div class="modal-form" style="display: flex; flex-direction: column; gap: 10px;">
				<input id="newCategoryInput" type="text" placeholder="ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„ ì…ë ¥" />
				<button onclick="addCategory()">+ ì¶”ê°€</button>

				<ul id="categoryList" style="margin-top: 20px; padding: 0;"></ul>
			</div>
		</div>
	</div>
	
	<div id="menuModal" class="modal-overlay">
		<div class="modal-content">
			<span class="close-btn" onclick="closeMenuModal()">&times;</span>
			<h2>ë©”ë‰´ ë“±ë¡</h2>
			<form id="menuForm" class="modal-form" method="post" enctype="multipart/form-data"
					th:action="@{'/owner/storeManagement/' + ${store.storeId} + '/menu-register'}">
				<label for="menuCategory">ì¹´í…Œê³ ë¦¬</label>
				<select id="menuCategory" name="menuCategoryId" required></select>
				<label for="menuName">ë©”ë‰´ëª…</label>
				<input id="menuName" name="menuName" type="text" placeholder="ex) ë¶ˆê³ ê¸° ë²„ê±°" required />
				<label for="price">ê°€ê²©</label>
				<input id="price" name="price" type="number" placeholder="ex) 1000" required min="0" />

				<textarea name="description" placeholder="ì„¤ëª…"></textarea>
				<input type="file" name="menuImg" accept="image/*" />

				<div id="option1-container" style="grid-column: span 2;"></div>
				<button type="button" id="add-option-btn" style="grid-column: span 2;">+ ì˜µì…˜ ì¶”ê°€</button>

				<select name="menuStatus">
					<option value="ACTIVE">íŒë§¤ ì¤‘</option>
					<option value="SOLD_OUT">í’ˆì ˆ</option>
				</select>

				<button type="submit">ë“±ë¡í•˜ê¸°</button>
			</form>
		</div>
	</div>
	
	<div id="editMenuModal" class="modal-overlay" style="display:none;">
		<div class="modal-content">
			<span class="close-btn" onclick="closeEditMenuModal()">&times;</span>
			<h2>ë©”ë‰´ ìˆ˜ì •</h2>
			<form id="editMenuForm" class="modal-form" method="post" enctype="multipart/form-data"
				  th:action="@{'/owner/storeManagement/' + ${store.storeId} + '/menu-edit'}">
				<input type="hidden" name="menuId" id="editMenuId" />
				<label for="editMenuCategory">ì¹´í…Œê³ ë¦¬</label>
				<select id="editMenuCategory" name="menuCategoryId" required></select>
				<label for="editMenuName">ë©”ë‰´ëª…</label>
				<input id="editMenuName" name="menuName" type="text" required />
				<label for="editPrice">ê°€ê²©</label>
				<input id="editPrice" name="price" type="number" required min="0" />
				<textarea name="description" id="editDescription"></textarea>
				<input type="file" name="menuImg" accept="image/*" />
				<!-- ì˜µì…˜, ìƒíƒœ ë“± í•„ìš”ì— ë”°ë¼ ì¶”ê°€ -->
				<select name="menuStatus" id="editMenuStatus">
					<option value="ACTIVE">íŒë§¤ ì¤‘</option>
					<option value="SOLD_OUT">í’ˆì ˆ</option>
				</select>
				<div id="edit-option-container" style="grid-column: span 2;"></div>
				<button type="button" id="edit-add-option-btn" style="grid-column: span 2;">+ ì˜µì…˜ ì¶”ê°€</button>
				<button type="submit">ìˆ˜ì •í•˜ê¸°</button>
			</form>
			<form id="deleteMenuForm" method="post"
				  th:action="@{'/owner/storeManagement/' + ${store.storeId} + '/menu-delete'}"
				  style="margin-top: 10px;">
				<input type="hidden" name="menuId" id="deleteMenuId">
				<button type="submit" class="delete-btn" style="background-color: red; color: white;">ì‚­ì œí•˜ê¸°</button>
			</form>
		</div>
	</div>

	<script th:src="@{/js/storeMenuManage.js}"></script>
	<script th:inline="javascript">
		/*<![CDATA[*/
		window.categoryList = JSON.parse([[${categoryListJson}]]);
		window.menuList = [[${menuList}]];
		/*]]>*/
	</script>
	<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
	<script>
	document.addEventListener('DOMContentLoaded', function () {
		const el = document.getElementById('menu-list-container'); // ë©”ë‰´ ì¹´ë“œ ë¶€ëª¨
		Sortable.create(el, {
			animation: 150,
			onEnd: function (evt) {
				const newOrder = [...el.children].map((card, idx) => ({
					menuId: card.dataset.menuId,
					order: idx
				}));
				console.log("ğŸ”ƒ ë³€ê²½ëœ ìˆœì„œ", newOrder);
				fetch('/owner/menu-reorder', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(newOrder)
				});
			}
		});
	});
	</script>
</body>
</html>